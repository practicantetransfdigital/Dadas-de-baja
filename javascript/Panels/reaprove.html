<script>

function showAmbientalValidationModal(requestId) {
    currentRequestId = requestId;
    
    // Buscar la informaci贸n de la solicitud para mostrar en el modal
    const tbody = document.getElementById('validadasTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        if (row.cells[0].textContent === requestId) {
            document.getElementById('ambientalRequestId').textContent = requestId;
            document.getElementById('ambientalElemento').textContent = row.cells[3].textContent;
            document.getElementById('ambientalSolicitante').textContent = row.cells[1].textContent;
            break;
        }
    }
    
    document.getElementById('ambientalForm').reset();
    document.getElementById('ambientalModal').style.display = 'block';
}

function closeAmbientalModal() {
    document.getElementById('ambientalModal').style.display = 'none';
    currentRequestId = null;
}

// Event listener para el formulario ambiental
document.getElementById('ambientalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const precioReal = document.getElementById('ambientalPrecioReal').value;
    const cantidadReal = document.getElementById('ambientalCantidadReal').value;
    const proveedor = document.getElementById('ambientalProveedor').value;
    const ticketBascula = document.getElementById('ticketBascula').value;
    const observaciones = document.getElementById('ambientalObservaciones').value;
    
    if (!precioReal || !cantidadReal) {
        showAlert('Debe completar el precio real y la cantidad real', 'error');
        return;
    }
    
    submitAmbientalValidation(currentRequestId, precioReal, cantidadReal, proveedor, observaciones, ticketBascula);
});

function submitAmbientalValidation(requestId, precioReal, cantidadReal, proveedor, observaciones, ticketBascula) {
    console.log(' Enviando re-aprobaci贸n ambiental:', { requestId, precioReal, cantidadReal, proveedor, observaciones, ticketBascula });
    showLoading();
    
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
                showAlert('Re-aprobaci贸n ambiental registrada exitosamente', 'success');
                closeAmbientalModal();
                // Recargar la lista para actualizar la interfaz
                refreshValidadas();
            } else {
                showAlert(result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            showAlert('Error de conexi贸n al registrar re-aprobaci贸n ambiental', 'error');
            console.error(error);
        })
        .submitAmbientalValidation(requestId, precioReal, cantidadReal, proveedor, observaciones, ticketBascula, currentUser);
}

// Actualizar el event listener para cerrar modal ambiental
window.onclick = function(event) {
    const detailModal = document.getElementById('detailModal');
    const customModal = document.getElementById('customModal');
    const ambientalModal = document.getElementById('ambientalModal');
    
    if (event.target === detailModal) {
        closeModal();
    }
    if (event.target === customModal) {
        closeCustomModal();
    }
    if (event.target === ambientalModal) {
        closeAmbientalModal();
    }
}

</script>