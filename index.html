<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Dadas de Baja</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oxygen:wght@300;400;700&display=swap" rel="stylesheet">
    <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
</head>

<body>
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://comarrico.com/wp-content/uploads/2018/02/Logo-menu-comarrico.png" class="logo-img" alt="COMARRICO">
                </div>
            </div>
            <h2 class="login-title">Gestion Dadas de Bajas</h2>
            <p class="login-subtitle">COMARRICOTE - 2025</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo ElectrÃ³nico</label>
                    <input type="email" id="email" name="email" placeholder="usuario@pastascomarrico.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">ContraseÃ±a</label>
                    <input type="password" id="password" autocomplete="current-password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>ğŸ”</span> Iniciar SesiÃ³n
                </button>
                
                <p class="register-link">
                    Â¿No tienes cuenta? <a href="javascript:void(0)" onclick="showRegister()">RegÃ­strate aquÃ­</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Pantalla de Registro -->
    <div id="registerScreen" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://comarrico.com/wp-content/uploads/2018/02/Logo-menu-comarrico.png" class="logo-img" alt="COMARRICO">
                </div>
            </div>
            <h2 class="login-title">Registro de Usuario</h2>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="regName">Nombre Completo</label>
                    <input type="text" id="regName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="regEmail">Correo ElectrÃ³nico</label>
                    <input type="email" id="regEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="regPassword">ContraseÃ±a</label>
                    <input type="password" id="regPassword" autocomplete="current-password" name="password" required>
                </div>
                
                <div class="form-group">
                    <label for="regProceso">Proceso</label>
                    <select id="regProceso" name="proceso" required>
                        <option value="">Seleccione un proceso</option>
                        <option value="ALMACÃ‰N GENERAL">ALMACÃ‰N GENERAL</option>
                        <option value="ALMACÃ‰N MATERIAS PRIMAS">ALMACÃ‰N MATERIAS PRIMAS</option>
                        <option value="LOGÃSTICA">LOGÃSTICA</option>
                        <option value="MOLINO">MOLINO</option>
                        <option value="EMPAQUE">EMPAQUE</option>
                        <option value="PASTIFICIO">PASTIFICIO</option>
                        <option value="MANUFACTURA">MANUFACTURA</option>
                        <option value="EXCELENCIA OPERACIONAL / PROYECTOS">EXCELENCIA OPERACIONAL / PROYECTOS</option>
                        <option value="PLANEACIÃ“N">PLANEACIÃ“N</option>
                        <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                        <option value="SISTEMA DE INFORMACIÃ“N">SISTEMA DE INFORMACIÃ“N</option>
                        <option value="CABAS">CABAS</option>
                        <option value="CALIDAD">CALIDAD</option>
                        <option value="AMBIENTAL">AMBIENTAL</option>
                        <option value="INNOVACIÃ“N Y DESARROLLO">INNOVACIÃ“N Y DESARROLLO</option>
                        <option value="MERCADEO">MERCADEO</option>
                        <option value="COMERCIAL">COMERCIAL</option>
                        <option value="GESTIÃ“N HUMANA">GESTIÃ“N HUMANA</option>
                        <option value="SEGURIDAD Y SALUD EN EL TRABAJO">SEGURIDAD Y SALUD EN EL TRABAJO</option>
                        <option value="CONTROL GESTION">CONTROL GESTION</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="regCargo">Cargo</label>
                    <input type="text" id="regCargo" name="cargo" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>ğŸ‘¤</span> Registrarse
                </button>
                
                <p class="register-link">
                    Â¿Ya tienes cuenta? <a href="javascript:void(0)" onclick="showLogin()">Inicia sesiÃ³n aquÃ­</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="dashboard" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-contain-sidebar">
                    <img src="https://comarrico.com/wp-content/uploads/2018/02/Logo-menu-comarrico.png" class="logo-sidebar" alt="COMARRICO">
                </div>
                <div class="system-title">
                    <h3 style="text-align: center;">SISTEMA DE BAJA</h3>
                    <p style="text-align: center;">GESTIÃ“N DE ELEMENTOS</p>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item active" id="navNuevaSolicitud" onclick="showNewRequest()">
                    <span class="nav-icon">ğŸ“</span>
                    Nueva Solicitud
                </div>
                <div class="nav-item" id="navHistorial" onclick="showHistory()">
                    <span class="nav-icon">ğŸ“‹</span>
                    Mi Historial
                </div>
                <div class="nav-item" id="navAdministracion" onclick="showAdmin()" style="display: none;">
                    <span class="nav-icon">âš™ï¸</span>
                    Pendientes
                </div>
                <div class="nav-item" id="navValidadas" onclick="showValidadas()" style="display: none;">
                    <span class="nav-icon">â™»ï¸</span>
                    Validadas
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <span class="user-name" id="userName">Usuario</span>
                        <span class="user-role" id="userRole">USUARIO</span>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <span>ğŸšª</span> Cerrar SesiÃ³n
                </button>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Nueva Solicitud -->
            <div id="newRequestContent" class="content-section">
                <div class="content-header">
                    <div>
                        <h1>Nueva Solicitud de Baja</h1>
                        <p>Complete el formulario para solicitar la baja de un elemento</p>
                    </div>
                </div>
                
                <form id="newRequestForm" class="request-form">
                    <div class="form-section">
                        <div class="section-header">
                            <span class="section-icon">ğŸ“¦</span>
                            <h3>InformaciÃ³n del Elemento</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="procesoSeleccionado">Proceso *</label>
                                <select id="procesoSeleccionado" name="procesoSeleccionado" required>
                                    <option value="">Seleccione el proceso</option>
                                    <option value="ALMACÃ‰N GENERAL">ALMACÃ‰N GENERAL</option>
                                    <option value="ALMACÃ‰N MATERIAS PRIMAS">ALMACÃ‰N MATERIAS PRIMAS</option>  
                                    <option value="MOLINO">MOLINO</option>
                                    <option value="EMPAQUE">EMPAQUE</option>
                                    <option value="PASTIFICIO">PASTIFICIO</option>
                                    <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                                    <option value="SISTEMA DE INFORMACIÃ“N">SISTEMA DE INFORMACIÃ“N</option>
                                    <option value="CALIDAD">CALIDAD</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="nombreElemento">Nombre del Elemento *</label>
                                <input type="text" id="nombreElemento" name="nombreElemento" 
                                       placeholder="Ej: Escritorio de oficina, Molde #123, etc." required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tipoElemento">Tipo de Elemento *</label>
                                <select id="tipoElemento" name="tipoElemento" onchange="toggleValorRango()" required>
                                    <option value="">Seleccione el tipo</option>
                                    <option value="MOLDES E INSERTOS">Moldes e Insertos</option>
                                    <option value="MAQUINARIA">Maquinaria</option>
                                    <option value="ESTIBAS DE MADERA Y/O GUACALES">Estibas de madera y/o Guacales</option>
                                    <option value="INSUMO MATERIA PRIMA">Insumo Materia Prima</option>
                                    <option value="INSUMOS MATERIALES DE EMPAQUE">Insumos Materiales de Empaque</option>
                                    <option value="MOBILIARIOS">Mobiliarios</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="tipo2">Tipo de Desperdicio * (Si no esta el elemento informar a Ambiental)</label>
                                  <select id="tipo2" name="tipo2" required>
                                    <option value="">Seleccione</option>
                                    <option value="Aceite mineral usado">Aceite mineral usado</option>
                                    <option value="Aceite Vegetal usado">Aceite Vegetal usado</option>
                                    <option value="Cables">Cables</option>
                                    <option value="Carton">Carton</option>
                                    <option value="Chatarra">Chatarra</option>
                                    <option value="Cores">Cores</option>
                                    <option value="Descarte">Descarte</option>
                                    <option value="Estiba completa">Estiba completa</option>
                                    <option value="Estiba rota, guacal, pedazos de madera">Estiba rota, guacal, pedazos de madera</option>
                                    <option value="Insertos">Insertos</option>
                                    <option value="Lonas">Lonas</option>
                                    <option value="Moldes">Moldes</option>
                                    <option value="Plastico Rigido">Plastico Rigido</option>
                                    <option value="Plastico Vario">Plastico Vario</option>
                                    <option value="Plegadiza">Plegadiza</option>
                                    <option value="Polietileno">Polietileno</option>
                                    <option value="Polipropileno">Polipropileno</option>
                                    <option value="Recorte Humedo">Recorte Humedo</option>
                                    <option value="Recorte Saborizado">Recorte Saborizado</option>
                                    <option value="Recorte Seco">Recorte Seco</option>
                                    <option value="Vasos desechables">Vasos desechables</option>
                                    <option value="Vidrio">Vidrio</option>
                                    <option value="Bolsas Metalizadas">Bolsas Metalizadas</option>
                                  </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="display: none;">
                                <label for="kiloGalon">Kilo / Galon *</label>
                                <input type="number" id="kiloGalon" name="kiloGalon" >
                            </div>
                            
                            <div class="form-group"  style="display: none;">
                                <label for="calculoPrecio">Precio total *</label>
                                <small id="calculoFormatted" style="font-weight:bold; color:green;"></small>
                                <input type="" id="calculoPrecio" name="calculoPrecio" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="descripcionDetallada">DescripciÃ³n Detallada</label>
                            <textarea id="descripcionDetallada" name="descripcionDetallada" 
                                      placeholder="Proporcione una descripciÃ³n detallada del elemento" rows="4"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-header">
                            <span class="section-icon">âš ï¸</span>
                            <h3>Motivo de la Baja</h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Seleccione el(los) motivo(s) de la baja *</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="DAÃ‘O FÃSICO IRREVERSIBLE">
                                    <span>DAÃ‘O FÃSICO IRREVERSIBLE</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="OBJETO INSERVIBLE">
                                    <span>OBJETO INSERVIBLE</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="OBSOLESCENCIA TÃ‰CNICA">
                                    <span>OBSOLESCENCIA TÃ‰CNICA</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="VENCIMIENTO O CADUCIDAD">
                                    <span>VENCIMIENTO O CADUCIDAD</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="CONTAMINACIÃ“N O MAL ALMACENAMIENTO">
                                    <span>CONTAMINACIÃ“N O MAL ALMACENAMIENTO</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="motivos" value="NO CUMPLE ESPECIFICACIONES TÃ‰CNICAS">
                                    <span>NO CUMPLE ESPECIFICACIONES TÃ‰CNICAS</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group" id="activoFijoGroup" style="display: none;">
                            <label for="esActivoFijo">Â¿Es un activo fijo? (Nota: Para verificar si el elemento corresponde a un activo fijo, comunÃ­quese con el equipo de IngenierÃ­a.)</label>
                            <select id="esActivoFijo" name="esActivoFijo" onchange="toggleValorRango()">
                                <option value="NO">NO</option>
                                <option value="SI">SÃ</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="valorRangoGroup" style="display: none;">
                          <label for="valorRango">Valor del elemento</label>
                          <select id="valorRango" name="valorRango" class="form-control" readonly>
                                <option value="">Seleccione el rango</option>
                                <option value="MENOR_5M">Menor a 5 millones</option>
                                <option value="MAYOR_5M">Mayor a 5 millones</option>
                          </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <span>ğŸ“¤</span> Enviar Solicitud
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <span>ğŸ”„</span> Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>

            <!-- Historial de Usuario -->
            <div id="historyContent" class="content-section" style="display: none;">
                <div class="content-header">
                    <div>
                        <h1>Mi Historial de Solicitudes</h1>
                        <p>Revise el estado de todas sus solicitudes de baja</p>
                    </div>
                    <button class="btn btn-primary" style="margin: 7rem 0rem 0rem 20rem" onclick="refreshHistory()">
                        <span>ğŸ”„</span> Actualizar
                    </button>
                </div>
                
                <div class="admin-panel">
                    <div class="panel-header">
                        <span class="panel-icon">ğŸ“‹</span>
                        <h3>Mis Solicitudes</h3>
                    </div>
                    
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>PROCESO</th>
                                    <th>ELEMENTO</th>
                                    <th>ESTADO</th>
                                    <th>FECHA SOLICITUD</th>
                                    <th>ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Contenido dinÃ¡mico -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Panel Administrativo -->
            <div id="adminContent" class="content-section" style="display: none;">
                <div class="content-header">
                    <div>
                        <h1>Panel Administrativo</h1>
                        <p>Gestione y valide las solicitudes de baja de elementos</p>
                    </div>
                    <button class="btn btn-primary" style="margin: 7rem 0rem 0rem 20rem" onclick="refreshAdmin()">
                        <span>ğŸ”„</span> Actualizar
                    </button>
                </div>
                
                <div class="admin-panel">
                    <div class="panel-header">
                        <span class="panel-icon">âš™ï¸</span>
                        <h3>Panel Administrativo</h3>
                    </div>
                    
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>SOLICITANTE</th>
                                    <th>PROCESO</th>
                                    <th>ELEMENTO</th>
                                    <th>ESTADO</th>
                                    <th>FECHA</th>
                                    <th>ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody">
                                <!-- Contenido dinÃ¡mico -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

<!-- Panel de Validadas -->
<div id="validadasContent" class="content-section" style="display: none;">
    <div class="content-header">
        <div>
            <h1>Solicitudes Validadas</h1>
            <p>Trazabilidad de todas las solicitudes completamente validadas</p>
        </div>
        <button class="btn btn-primary" style="margin: 7rem 0rem 0rem 20rem" onclick="refreshValidadas()">
            <span>ğŸ”„</span> Actualizar
        </button>
    </div>
    
    <div class="admin-panel">
        <div class="panel-header">
            <span class="panel-icon">âœ…</span>
            <h3>Historial de Validadas</h3>
        </div>
        
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>SOLICITANTE</th>
                        <th>PROCESO</th>
                        <th>ELEMENTO</th>
                        <th>TIPO</th>
                        <th>FECHA SOLICITUD</th>
                        <th>FECHA VALIDACIÃ“N</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="validadasTableBody">
                    <!-- Contenido dinÃ¡mico -->
                </tbody>
            </table>
        </div>
    </div>
</div> 
</div>
</div>

    <!-- Modal estÃ¡tico para ver detalles - contenido fijo en HTML -->
    <div id="detailModal" class="modal" style="display: none; align-content: center;text-align: -webkit-center;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“‹ Detalles de la Solicitud</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="staticDetailContent">
                    <div class="request-details">
                        <div class="detail-section">
                            <h4>ğŸ“‹ InformaciÃ³n General</h4>
                            <p><strong>ID:</strong> <span id="detail-id">-</span></p>
                            <p><strong>Solicitante:</strong> <span id="detail-solicitante">-</span></p>
                            <p><strong>Correo:</strong> <span id="detail-correo">-</span></p>
                            <p><strong>Proceso:</strong> <span id="detail-proceso">-</span></p>
                            <p><strong>Estado:</strong> <span id="detail-estado" class="status-badge">-</span></p>
                            <p><strong>Fecha Solicitud:</strong> <span id="detail-fecha">-</span></p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ“¦ InformaciÃ³n del Elemento</h4>
                            <p><strong>Nombre:</strong> <span id="detail-elemento">-</span></p>
                            <p><strong>Tipo:</strong> <span id="detail-tipo">-</span></p>
                            <p><strong>Tipo de Desperdicio:</strong> <span id="detail-tipo2">-</span></p>
                            <p><strong>Motivo:</strong> <span id="detail-motivoBaja">-</span></p>
                            <p><strong>Es Activo Fijo:</strong> <span id="detail-activo">-</span></p>
                            <p><strong>Kilos o Galones:</strong> <span id="detail-kiloGalon">-</span></p>
                            <p><strong>Precio:</strong> <span id="detail-precio">-</span></p>
                            <p><strong>Valor:</strong> <span id="detail-valor">-</span></p>
                        </div>
                        
                        <div class="detail-section" id="validationsSection">
                            <h4>ğŸ‘¥ Historial de Validaciones</h4> 
                            <div id="validationsList" class="validations-list">
                                <!-- Validaciones se cargan aquÃ­ -->
                            </div>
                        </div>
                        
                        <div class="detail-section" id="observationsSection" style="display: none;">
                            <h4>ğŸ“ Observaciones</h4>
                            <p id="detail-observaciones">-</p>
                        </div>

<div class="detail-section" id="ambientalValidationSection" style="display: none;">
    <h4>ğŸŒ± ValidaciÃ³n Ambiental</h4>
    <div id="ambientalValidationsList" class="validations-list">
        <!-- Las validaciones ambientales se cargarÃ¡n aquÃ­, igual que las individuales -->
    </div>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaciÃ³n Personalizado -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="customModalTitle">
                    <span id="customModalIcon">â“</span>
                    <span id="customModalTitleText">ConfirmaciÃ³n</span>
                </h3>
            </div>
            <div class="custom-modal-body">
                <p id="customModalMessage">Â¿EstÃ¡ seguro de realizar esta acciÃ³n?</p>
                <input type="text" id="customModalInput" class="custom-modal-input" placeholder="Ingrese sus observaciones..." style="display: none;">
            </div>
            <div class="custom-modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomModal()">
                    <span>âŒ</span> Cancelar
                </button>
                <button class="btn btn-primary" id="customModalConfirm" onclick="confirmCustomModal()">
                    <span>âœ…</span> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para ValidaciÃ³n Ambiental -->
<div id="ambientalModal" class="modal" style="display: none; align-content: center;text-align: -webkit-center;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>ğŸŒ± Re-aprobaciÃ³n Ambiental</h3>
            <span class="close" onclick="closeAmbientalModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="request-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>InformaciÃ³n de la Solicitud</h4>
                <p><strong>ID:</strong> <span id="ambientalRequestId">-</span></p>
                <p><strong>Elemento:</strong> <span id="ambientalElemento">-</span></p>
                <p><strong>Solicitante:</strong> <span id="ambientalSolicitante">-</span></p>
            </div>
            
            <form id="ambientalForm">
                <div class="form-group">
                    <label for="ambientalPrecioReal">Precio Real del Desecho *</label>
                    <input type="number" id="ambientalPrecioReal" name="precioReal" 
                           step="0.01" min="0" required placeholder="Ingrese el precio real">
                </div>
                
                <div class="form-group">
                    <label for="ambientalCantidadReal">Cantidad Real del Desecho *</label>
                    <input type="number" id="ambientalCantidadReal" name="cantidadReal" 
                           step="0.01" min="0" required placeholder="Ingrese la cantidad real">
                    <small style="color: #666;">En Kg, Galones o unidades segÃºn corresponda</small>
                </div>
                
                <div class="form-group">
                    <label for="ambientalObservaciones">Observaciones</label>
                    <textarea id="ambientalObservaciones" name="observaciones" 
                              placeholder="Ingrese observaciones adicionales del proceso de desecho..." 
                              rows="4"></textarea>
                </div>
                
                <div class="form-actions" style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAmbientalModal()">
                        <span>âŒ</span> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span>âœ…</span> Registrar Re-aprobaciÃ³n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <script>
        let currentUser = null;
        let currentRequestId = null;
        let customModalCallback = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE AUTENTICACIÃ“N Y NAVEGACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('registerScreen').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            showAlert('SesiÃ³n cerrada exitosamente', 'success');
        }

        function showNewRequest() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('newRequestContent').style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('navNuevaSolicitud').classList.add('active');
        }

        function showHistory() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('historyContent').style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('navHistorial').classList.add('active');
            
            loadUserHistory();
        }

        function showAdmin() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('adminContent').style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('navAdministracion').classList.add('active');
            
            loadAdminRequestsWithDebug();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE UTILIDAD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            alertDiv.innerHTML = `
                <span class="alert-icon">${icon}</span>
                <span class="alert-message">${message}</span>
                <button class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function toggleValorRango() {
            const tipoElemento = document.getElementById('tipoElemento').value;
            const esActivoFijo = document.getElementById('esActivoFijo').value;
            const activoFijoGroup = document.getElementById('activoFijoGroup');
            const valorRangoGroup = document.getElementById('valorRangoGroup');
            
            const elementosActivoFijo = ['MOLDES E INSERTOS', 'MAQUINARIA', 'MOBILIARIOS'];
            
            if (elementosActivoFijo.includes(tipoElemento)) {
                activoFijoGroup.style.display = 'block';
                
                if (esActivoFijo === 'SI') {
                    valorRangoGroup.style.display = 'none';
                    document.getElementById('valorRango').value = '';
                } else {
                    valorRangoGroup.style.display = 'block';
                }
            } else if (tipoElemento) {
                activoFijoGroup.style.display = 'none';
                valorRangoGroup.style.display = 'block';
                document.getElementById('esActivoFijo').value = 'NO';
            } else {
                activoFijoGroup.style.display = 'none';
                valorRangoGroup.style.display = 'none';
            }
        }

function updateUserInterface() {
    if (currentUser) {
        document.getElementById('userName').textContent = currentUser.nombre;
        document.getElementById('userRole').textContent = currentUser.rol;
        document.getElementById('userAvatar').textContent = currentUser.nombre.charAt(0).toUpperCase();
        
        // Mostrar menÃº segÃºn el rol
        if (currentUser.rol === 'JEFE' || currentUser.rol === 'ADMIN') {
            document.getElementById('navAdministracion').style.display = 'block';
            document.getElementById('navValidadas').style.display = 'block';
            showAdmin();
        } else if (currentUser.rol === 'AMBIENTAL') {
            document.getElementById('navAdministracion').style.display = 'none';
            document.getElementById('navValidadas').style.display = 'block';
            // Para usuarios AMBIENTAL, mostrar directamente el panel de validadas
            showValidadas();
        } else {
            document.getElementById('navAdministracion').style.display = 'none';
            document.getElementById('navValidadas').style.display = 'none';
            showNewRequest();
        }
    }
}

        function formatDate(date) {
            if (!date) return 'N/A';
            
            if (typeof date === 'string') {
                const parsedDate = new Date(date);
                if (!isNaN(parsedDate.getTime())) {
                    return parsedDate.toLocaleDateString('es-ES');
                }
                return date;
            }
            
            if (date instanceof Date) {
                return date.toLocaleDateString('es-ES');
            }
            
            const d = new Date(date);
            if (!isNaN(d.getTime())) {
                return d.toLocaleDateString('es-ES');
            }
            
            return 'N/A';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showCustomModal(title, message, showInput = false, callback = null) {
            const modal = document.getElementById('customModal');
            const titleElement = document.getElementById('customModalTitleText');
            const messageElement = document.getElementById('customModalMessage');
            const inputElement = document.getElementById('customModalInput');
            const iconElement = document.getElementById('customModalIcon');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            inputElement.style.display = showInput ? 'block' : 'none';
            inputElement.value = '';
            
            if (title.includes('Validar')) {
                iconElement.textContent = 'âœ…';
            } else if (title.includes('Rechazar')) {
                iconElement.textContent = 'âŒ';
            } else {
                iconElement.textContent = 'â“';
            }
            
            customModalCallback = callback;
            modal.style.display = 'flex';
        }

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            customModalCallback = null;
        }

        function confirmCustomModal() {
            const inputElement = document.getElementById('customModalInput');
            const inputValue = inputElement.value.trim();
            
            if (customModalCallback) {
                customModalCallback(inputValue);
            }
            
            closeCustomModal();
        }

        function showValidateRequestModal(requestId) {
            currentRequestId = requestId;
            showCustomModal(
                'Validar Solicitud',
                'Â¿EstÃ¡ seguro de que desea validar esta solicitud?',
                true,
                function(observaciones) {
                    validateRequest(requestId, observaciones);
                }
            );
        }

        function showRejectRequestModal(requestId) {
            currentRequestId = requestId;
            showCustomModal(
                'Rechazar Solicitud',
                'Â¿EstÃ¡ seguro de que desea rechazar esta solicitud? Ingrese el motivo del rechazo:',
                true,
                function(motivo) {
                    if (!motivo.trim()) {
                        showAlert('Debe ingresar un motivo para el rechazo', 'error');
                        return;
                    }
                    rejectRequest(requestId, motivo);
                }
            );
        }

        function viewRequest(requestId) {
            console.log('[v0] Cargando detalles de solicitud:', requestId);
            showLoading();
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    console.log('[v0] Respuesta recibida:', result);
                    
                    if (result && result.success && result.request) {
                        displayStaticRequestDetails(result);
                    } else {
                        console.log('[v0] Error en respuesta:', result);
                        console.log('Resultado real:', JSON.stringify(result));
                        showAlert(result?.message || 'Error al cargar detalles de la solicitud', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.log('[v0] Error en llamada:', error);
                    showAlert('Error de conexiÃ³n al cargar detalles', 'error');
                })
                .getRequestDetails(requestId);
        }

function displayStaticRequestDetails(data) {
    const request = data.request;
    
    // Llenar informaciÃ³n bÃ¡sica
    document.getElementById('detail-id').textContent = request.id || 'N/A';
    document.getElementById('detail-solicitante').textContent = request.nombreSolicitante || 'N/A';
    document.getElementById('detail-correo').textContent = request.correoSolicitante || 'N/A';
    document.getElementById('detail-proceso').textContent = request.proceso || 'N/A';
    document.getElementById('detail-estado').textContent = request.estado || 'N/A';
    document.getElementById('detail-fecha').textContent = request.fechaSolicitud || 'N/A';
    document.getElementById('detail-elemento').textContent = request.nombreElemento || 'N/A';
    document.getElementById('detail-tipo').textContent = request.tipoElemento || 'N/A';
    document.getElementById('detail-tipo2').textContent = request.tipo2 || 'N/A';
    document.getElementById('detail-motivoBaja').textContent = request.motivoBaja || 'N/A';
    document.getElementById('detail-activo').textContent = request.esActivoFijo || 'N/A';
    document.getElementById('detail-valor').textContent = request.valorRango || 'N/A';
    document.getElementById('detail-kiloGalon').textContent = 
    request.kiloGalon ? parseFloat(request.kiloGalon).toLocaleString('es-ES') : 'N/A';
    document.getElementById('detail-precio').textContent = 
    request.calculoFormatted ? parseFloat(request.calculoFormatted).toLocaleString('es-ES') : 'N/A';
    
    // âœ… MOSTRAR VALIDACIONES INDIVIDUALES (EXISTENTE)
    const validationsList = document.getElementById('validationsList');
    validationsList.innerHTML = '';
    
    if (data.individualValidations && data.individualValidations.length > 0) {
        data.individualValidations.forEach(validation => {
            const statusIcon = validation.estado === 'VALIDADA' ? 'âœ…' : 'âŒ';
            const statusClass = validation.estado === 'VALIDADA' ? 'approved' : 'rejected';
            
            const validationDiv = document.createElement('div');
            validationDiv.className = `validation-item ${statusClass}`;
            validationDiv.innerHTML = `
                <div class="validation-header">
                    <span class="validation-validator">${statusIcon} <strong>${validation.validador}</strong></span>
                    <span class="validation-date">${validation.fecha}</span>
                </div>
                <div class="validation-status">Estado: <strong>${validation.estado}</strong></div>
                ${validation.observaciones ? `<div class="validation-obs">Observaciones: ${validation.observaciones}</div>` : ''}
            `;
            validationsList.appendChild(validationDiv);
        });
        document.getElementById('validationsSection').style.display = 'block';
    } else {
        document.getElementById('validationsSection').style.display = 'none';
    }
    
    // âœ… MOSTRAR VALIDACIONES AMBIENTALES (EXACTAMENTE IGUAL)
    const ambientalList = document.getElementById('ambientalValidationsList');
    ambientalList.innerHTML = '';
    
    if (data.ambientalValidations && data.ambientalValidations.length > 0) {
        data.ambientalValidations.forEach(validation => {
            const ambientalDiv = document.createElement('div');
            ambientalDiv.className = 'validation-item approved'; // Siempre approved para ambiental
            ambientalDiv.innerHTML = `
                <div class="validation-header">
                    <span class="validation-validator"></span>
                    <span class="validation-date">${validation.fecha}</span>
                </div>
                <div class="validation-status">
                    <p><strong>Precio Real:</strong> $${parseFloat(validation.precioReal).toLocaleString('es-CO')}</p>
                    <p><strong>Cantidad Real:</strong> ${parseFloat(validation.cantidadReal).toLocaleString('es-CO')}</p>
                    ${validation.observaciones ? `<p><strong>Observaciones:</strong> ${validation.observaciones}</p>` : ''}
                    <p><strong>Validado por:</strong> ${validation.validadoPor || 'N/A'}</p>
                </div>
            `;
            ambientalList.appendChild(ambientalDiv);
        });
        document.getElementById('ambientalValidationSection').style.display = 'block';
    } else {
        document.getElementById('ambientalValidationSection').style.display = 'none';
    }
    
    // Mostrar observaciones si existen
    if (request.observaciones) {
        document.getElementById('detail-observaciones').textContent = request.observaciones;
        document.getElementById('observationsSection').style.display = 'block';
    } else {
        document.getElementById('observationsSection').style.display = 'none';
    }
    
    // Mostrar modal
    document.getElementById('detailModal').style.display = 'block';
}   

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentRequestId = null;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE VALIDACIÃ“N Y RECHAZO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function validateRequest(requestId, observaciones) {
            console.log('[v0] Iniciando validaciÃ³n:', requestId, observaciones);
            showLoading();
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    console.log('[v0] Resultado de validaciÃ³n:', result);
                    
                    if (result && result.success) {
                        showAlert(result.message || 'Solicitud validada exitosamente', 'success');
                        refreshAdmin();
                    } else {
                        console.log('[v0] Error en validaciÃ³n:', result);
                        showAlert(result?.message || 'Error al validar solicitud', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.log('[v0] Error en llamada de validaciÃ³n:', error);
                    showAlert('Error de conexiÃ³n al validar', 'error');
                })
                .validateRequest(requestId, observaciones, currentUser);
        }

        function rejectRequest(requestId, observaciones) {
            console.log('[v0] Iniciando rechazo:', requestId, observaciones);
            showLoading();
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    console.log('[v0] Resultado de rechazo:', result);
                    
                    if (result && result.success) {
                        showAlert(result.message || 'Solicitud rechazada exitosamente', 'success');
                        refreshAdmin();
                    } else {
                        console.log('[v0] Error en rechazo:', result);
                        showAlert(result?.message || 'Error al rechazar solicitud', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.log('[v0] Error en llamada de rechazo:', error);
                    showAlert('Error de conexiÃ³n al rechazar', 'error');
                })
                .rejectRequest(requestId, observaciones, currentUser);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE CARGA DE DATOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function loadUserHistory() {
            if (!currentUser) return;
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(requests) {
                    hideLoading();
                    displayUserHistory(requests);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('Error al cargar historial', 'error');
                })
                .getUserRequests(currentUser.correo);
        }

        function loadAdminRequestsWithDebug() {
  console.log('ğŸ”§ Cargando solicitudes admin en modo debug...');
  
  showLoading();
  google.script.run
    .withSuccessHandler(function(requests) {
      hideLoading();
      console.log('ğŸ“‹ Solicitudes recibidas en debug:', requests);
      
      if (!requests || requests.length === 0) {
        console.log('â„¹ï¸ No hay solicitudes para este usuario');
        document.getElementById('adminTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align: center;">No hay solicitudes pendientes para validar</td></tr>';
        return;
      }
      
      // Usar la versiÃ³n simple para mostrar
      displayAdminRequests(requests);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('âŒ Error en loadAdminRequestsWithDebug:', error);
      
      // Mostrar mensaje de error al usuario
      document.getElementById('adminTableBody').innerHTML = 
        '<tr><td colspan="7" style="text-align: center; color: red;">Error al cargar solicitudes: ' + error.message + '</td></tr>';
    })
    .getAdminRequests(currentUser);
}

        function displayUserHistory(requests) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay solicitudes registradas por tu parte</td></tr>';
                return;
            }
            
            requests.forEach(request => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td>${request.proceso}</td>
                    <td>${request.nombreElemento}</td>
                    <td><span class="status-badge status-${request.estado.toLowerCase()}">${request.estado}</span></td>
                    <td>${formatDate(request.fechaSolicitud)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewRequest('${request.id}')">
                             Ver
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

 function displayAdminRequests(requests) {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    
    if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay solicitudes para validar</td></tr>';
        return;
    }
    
    // Primero obtener todas las validaciones existentes para estas solicitudes
    const requestIds = requests.map(req => req.id);
    
    showLoading();
    google.script.run
        .withSuccessHandler(function(allValidations) {
            hideLoading();
            
            requests.forEach(request => {
                const row = document.createElement('tr');
                
                // Buscar si el usuario actual ya validÃ³ esta solicitud
                const userValidations = allValidations.filter(validation => 
                    validation.requestId == request.id && 
                    validation.correoValidador === currentUser.correo
                );
                
                const userAlreadyValidated = userValidations.length > 0;
                const canValidate = request.estado === 'PENDIENTE_VALIDACION' && !userAlreadyValidated;
                
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td>${request.nombreSolicitante}</td>
                    <td>${request.proceso}</td>
                    <td>${request.nombreElemento}</td>
                    <td><span class="status-badge status-${request.estado.toLowerCase()}">${request.estado}</span></td>
                    <td>${formatDate(request.fechaSolicitud)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewRequest('${request.id}')">
                            <span></span> Ver
                        </button>
                        ${canValidate ? `
                            <button class="btn btn-sm btn-success" onclick="showValidateRequestModal('${request.id}')">
                                <span>âœ…</span> 
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="showRejectRequestModal('${request.id}')">
                                <span>âŒ</span> 
                            </button>
                        ` : userAlreadyValidated ? `
                            <span class="already-validated-badge">âœ…</span>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .withFailureHandler(function(error) {
            hideLoading();
            console.error('Error al cargar validaciones:', error);
            // Si falla, mostrar todos los botones por seguridad
            displayAdminRequestsFallback(requests);
        })
        .getMultipleValidations(requestIds);
}

// FunciÃ³n de respaldo por si falla la carga de validaciones
function displayAdminRequestsFallback(requests) {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    
    requests.forEach(request => {
        const row = document.createElement('tr');
        const canValidate = request.estado === 'PENDIENTE_VALIDACION';
        
        row.innerHTML = `
            <td>${request.id}</td>
            <td>${request.nombreSolicitante}</td>
            <td>${request.proceso}</td>
            <td>${request.nombreElemento}</td>
            <td><span class="status-badge status-${request.estado.toLowerCase()}">${request.estado}</span></td>
            <td>${formatDate(request.fechaSolicitud)}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewRequest('${request.id}')">
                    <span></span> Ver
                </button>
                ${canValidate ? `
                    <button class="btn btn-sm btn-success" onclick="showValidateRequestModal('${request.id}')">
                        <span>âœ…</span> 
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="showRejectRequestModal('${request.id}')">
                        <span>âŒ</span> 
                    </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
}

        function refreshHistory() {
            loadUserHistory();
        }

        function refreshAdmin() {
            loadAdminRequestsWithDebug();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT LISTENERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        currentUser = result.user;
                        updateUserInterface();
                        showDashboard();
                        showAlert('Bienvenido al sistema', 'success');
                    } else {
                        showAlert(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('Error de conexiÃ³n', 'error');
                })
                .loginUser(email, password);
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showAlert('Usuario registrado exitosamente', 'success');
                        showLogin();
                        e.target.reset();
                    } else {
                        showAlert(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('Error de conexiÃ³n', 'error');
                })
                .registerUser(userData);
        });

        document.getElementById('newRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const requestData = Object.fromEntries(formData);
            
            const motivos = Array.from(document.querySelectorAll('input[name="motivos"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (motivos.length === 0) {
                showAlert('Debe seleccionar al menos un motivo de baja', 'error');
                return;
            }
            
            requestData.motivos = motivos.join(', ');
            requestData.correoSolicitante = currentUser.correo;
            requestData.nombreSolicitante = currentUser.nombre;
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showAlert('Solicitud enviada exitosamente', 'success');
                        e.target.reset();
                        toggleValorRango();
                    } else {
                        showAlert(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('Error de conexiÃ³n', 'error');
                })
                .submitRequest(requestData);
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const customModal = document.getElementById('customModal');
            
            if (event.target === detailModal) {
                closeModal();
            }
            if (event.target === customModal) {
                closeCustomModal();
            }
        }

        // Al cargar la pÃ¡gina, verificar si hay un usuario autenticado
        window.onload = function() {
            google.script.run
                .withSuccessHandler(function(user) {
                    if (user) {
                        currentUser = user;
                        updateUserInterface();
                        showDashboard();
                    } else {
                        showLogin();
                    }
                })
                .getLoggedInUser();
        };

let precioUnitario = null;

// Cuando selecciona Tipo II
document.getElementById("tipo2").addEventListener("change", function () {
  const tipo = this.value;
  console.log("Tipo seleccionado:", tipo);

  if (tipo) {
    document.getElementById("kiloGalon").parentElement.style.display = "block";

    // Llamada a Apps Script para traer el precio
    google.script.run.withSuccessHandler(function (precio) {
      console.log("Precio recibido:", precio);
      precioUnitario = precio;
    }).getPrecioPorTipo(tipo);

  } else {
    document.getElementById("kiloGalon").parentElement.style.display = "none";
    document.getElementById("calculoPrecio").parentElement.style.display = "none";
    document.getElementById("valorRangoGroup").style.display = "none";
    precioUnitario = null;
  }
});

// ğŸ‘‰ Cuando termina de escribir la cantidad
document.getElementById("kiloGalon").addEventListener("change", function () {
  const cantidad = parseFloat(this.value);
  console.log("Cantidad ingresada:", cantidad, "Precio unitario:", precioUnitario);

  if (!isNaN(cantidad) && precioUnitario !== null) {
    const total = cantidad * precioUnitario;
    console.log("Total calculado:", total);

    // Mostrar en el input de precio
    document.getElementById("calculoPrecio").value = total.toLocaleString("es-CO", {
      minimumFractionDigits: 2,
    });
    document.getElementById("calculoPrecio").parentElement.style.display = "block";

    // ğŸ‘‰ Autocompletar valorRango segÃºn el total
    const valorRangoGroup = document.getElementById("valorRangoGroup");
    const valorRango = document.getElementById("valorRango");

    valorRangoGroup.style.display = "block";
    if (total > 5000000) {
      valorRango.value = "MAYOR_5M";
    } else {
      valorRango.value = "MENOR_5M";
    }

    // ğŸ‘‰ Guardar en el objeto de la solicitud
    if (!window.currentRequest) window.currentRequest = {};
    window.currentRequest.calculoPrecio = total;
    window.currentRequest.calculoFormatted = total.toLocaleString("es-CO", {
      minimumFractionDigits: 2,
    });
    window.currentRequest.valorRango = valorRango.value; // ğŸ”¥ guardar tambiÃ©n el rango

  } else {
    document.getElementById("calculoPrecio").parentElement.style.display = "none";
    document.getElementById("valorRangoGroup").style.display = "none";
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES PARA EL PANEL DE VALIDADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showValidadas() {
    console.log("ğŸŸ¡ Mostrando panel de Validadas");
    
    // Ocultar todas las secciones
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Mostrar solo el panel de Validadas
    const validadasContent = document.getElementById('validadasContent');
    if (validadasContent) {
        validadasContent.style.display = 'block';
        console.log("âœ… Panel Validadas mostrado");
    } else {
        console.error("âŒ No se encuentra el elemento validadasContent");
    }
    
    // Actualizar navegaciÃ³n activa
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const navValidadas = document.getElementById('navValidadas');
    if (navValidadas) {
        navValidadas.classList.add('active');
    }
    
    // Cargar datos
    loadValidadasRequests();
}

function loadValidadasRequests() {
  if (!currentUser) return;

  showLoading();
  
  // Usar la nueva funciÃ³n que incluye el estado ambiental
  google.script.run
    .withSuccessHandler(function(validatedRequests) {
      hideLoading();
      console.log("ğŸ“¦ Datos recibidos en frontend:", validatedRequests); 
      displayValidadasRequests(validatedRequests);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('Error al cargar solicitudes validadas', 'error');
      console.error(error);
    })
    .getValidatedRequestsWithAmbientalStatus();
}

function displayValidadasRequests(requests) {
    console.log("ğŸŸ¡ displayValidadasRequests ejecutÃ¡ndose");
    console.log("ğŸ“Š Requests recibidos:", requests);
    
    const tbody = document.getElementById('validadasTableBody');
    if (!tbody) {
        console.error("âŒ NO SE ENCUENTRA el tbody con id 'validadasTableBody'");
        showAlert('Error: No se puede mostrar la tabla', 'error');
        return;
    }
    
    console.log("âœ… tbody encontrado correctamente");
    tbody.innerHTML = '';
    
    if (!requests || requests.length === 0) {
        console.log("â„¹ï¸ No hay solicitudes validadas");
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay solicitudes validadas registradas</td></tr>';
        return;
    }
    
    console.log(`ğŸŸ¢ Procesando ${requests.length} solicitudes validadas`);
    
    requests.forEach((request, index) => {
        console.log(`ğŸ“ Procesando request ${index}:`, request);
        
        const row = document.createElement('tr');
        
        // Determinar si mostrar botÃ³n de re-aprobaciÃ³n (solo para usuarios AMBIENTAL y si NO estÃ¡ ya procesado)
        const showReaprobarButton = currentUser.rol === 'AMBIENTAL' && !request.yaProcesadoAmbiental;
        
        row.innerHTML = `
            <td>${request.id || 'N/A'}</td>
            <td>${request.nombreSolicitante || 'N/A'}</td>
            <td>${request.proceso || 'N/A'}</td>
            <td>${request.nombreElemento || 'N/A'}</td>
            <td>${request.tipoElemento || 'N/A'}</td>
            <td>${formatDate(request.fechaSolicitud)}</td>
            <td>${formatDate(request.fechaValidacion)}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewRequest('${request.id}')">
                    <span></span> Ver
                </button>
                ${showReaprobarButton ? `
                <button class="btn btn-sm btn-success" onclick="showAmbientalValidationModal('${request.id}')" title="Re-aprobar ambientalmente">
                    <span></span> Re-aprobar
                </button>
                ` : request.yaProcesadoAmbiental ? `
                <span class="already-validated-badge">
                    Re-aprobado
                </span>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    console.log("âœ… Tabla poblada exitosamente. Filas agregadas:", tbody.children.length);
}

function refreshValidadas() {
    console.log("ğŸ”„ Actualizando panel de Validadas");
    loadValidadasRequests();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES PARA RE-APROBACIÃ“N AMBIENTAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showAmbientalValidationModal(requestId) {
    currentRequestId = requestId;
    
    // Buscar la informaciÃ³n de la solicitud para mostrar en el modal
    const tbody = document.getElementById('validadasTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        if (row.cells[0].textContent === requestId) {
            document.getElementById('ambientalRequestId').textContent = requestId;
            document.getElementById('ambientalElemento').textContent = row.cells[3].textContent;
            document.getElementById('ambientalSolicitante').textContent = row.cells[1].textContent;
            break;
        }
    }
    
    document.getElementById('ambientalForm').reset();
    document.getElementById('ambientalModal').style.display = 'block';
}

function closeAmbientalModal() {
    document.getElementById('ambientalModal').style.display = 'none';
    currentRequestId = null;
}

// Event listener para el formulario ambiental
document.getElementById('ambientalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const precioReal = document.getElementById('ambientalPrecioReal').value;
    const cantidadReal = document.getElementById('ambientalCantidadReal').value;
    const observaciones = document.getElementById('ambientalObservaciones').value;
    
    if (!precioReal || !cantidadReal) {
        showAlert('Debe completar el precio real y la cantidad real', 'error');
        return;
    }
    
    submitAmbientalValidation(currentRequestId, precioReal, cantidadReal, observaciones);
});

function submitAmbientalValidation(requestId, precioReal, cantidadReal, observaciones) {
    console.log('ğŸŒ± Enviando re-aprobaciÃ³n ambiental:', { requestId, precioReal, cantidadReal, observaciones });
    showLoading();
    
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
                showAlert('Re-aprobaciÃ³n ambiental registrada exitosamente', 'success');
                closeAmbientalModal();
                // Recargar la lista para actualizar la interfaz
                refreshValidadas();
            } else {
                showAlert(result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            showAlert('Error de conexiÃ³n al registrar re-aprobaciÃ³n ambiental', 'error');
            console.error(error);
        })
        .submitAmbientalValidation(requestId, precioReal, cantidadReal, observaciones, currentUser);
}

// Actualizar el event listener para cerrar modal ambiental
window.onclick = function(event) {
    const detailModal = document.getElementById('detailModal');
    const customModal = document.getElementById('customModal');
    const ambientalModal = document.getElementById('ambientalModal');
    
    if (event.target === detailModal) {
        closeModal();
    }
    if (event.target === customModal) {
        closeCustomModal();
    }
    if (event.target === ambientalModal) {
        closeAmbientalModal();
    }
}
    </script>
</body>
</html>
